<html>
<head>
	<title>ElectronWinwheel</title>
	<link rel="stylesheet" href="main.css" type="text/css" />
	<script src='jquery-3.2.0.js'></script>
	<script src='jQuery-FontSpy.js'></script>
	<script src='TweenMax.js'></script>
	<script src='Winwheel.js'></script>
</head>
<body>
	<canvas id='canvas'>
		Canvas not supported, use another browser.
	</canvas>
	<script>
		// process command line arguments
		if (nw.App.argv.length < 2) {
			throw 'Arguments should be of the form: ["value 1", "value 2", ...] n. Where n references the chosen option (starting from 0).';
		}
		var options = JSON.parse(nw.App.argv[0]);
		if (!Array.isArray(options) || options.length < 2 || options.length % 2) {
			throw '1st parameter must be an array with at least 2 values and its length must be and even number.';
		}
		var chosenOptionIdx = parseInt(nw.App.argv[1]);
		if (!Number.isInteger(chosenOptionIdx) || chosenOptionIdx < 0 || chosenOptionIdx >= options.length) {
			throw '2nd parameter must be an integer between 0 and ' + (options.length - 1) + '.';
		}

		var docWidth = document.body.clientWidth;
		var docHeight = document.body.clientHeight;

		var canvas = document.getElementById('canvas');
		var context = canvas.getContext('2d');
		canvas.width = docWidth;
		canvas.height = docHeight;

		var outerRadius = Math.min(docWidth, docHeight) * 0.45;
		var lineWidth = outerRadius * 0.01;
		var textFontSize = outerRadius * 0.075;

		// Prepare pointer values
		var pointerStyle = '#2196F3';
		var pointerWidth = outerRadius * 0.1;
		var pointerHeight = pointerWidth;
		var pointerInitialPosX = docWidth / 2 + outerRadius * 0.95
		var pointerInitialPosY = docHeight / 2;
		var pointerPositions = [
			[pointerInitialPosX, pointerInitialPosY],
			[pointerInitialPosX + pointerWidth, pointerInitialPosY - pointerHeight / 2],
			[pointerInitialPosX + pointerWidth, pointerInitialPosY + pointerHeight / 2]
		];

		// prepare segments for winwheel
		segments = [];
		options.forEach((element, index) => {
			var fillStyle = index % 2 ? '#673AB7' : '#4527A0';
			segments.push({fillStyle: fillStyle, strokeStyle: '#311B92', text: element});
		})

		var segmentAngle = 360 / segments.length;
		var stopAt = Math.floor(segmentAngle * chosenOptionIdx) + 1 + Math.floor(Math.random() * (Math.ceil(segmentAngle) - 1)) - 90;

		var pinStyle = '#FFEA00';
	
		fontSpy('Chunkfive', {
			success: function() {
				var theWheel = new Winwheel({
					'numSegments'   : segments.length,
					'outerRadius'   : outerRadius,
					'textFillStyle' : 'white',
					'textFontFamily': 'Chunkfive',
					'textFontWeight': 'normal',
					'textFontSize'  : textFontSize,
					'segments'      : segments,
					'lineWidth'     : lineWidth,
					'pins' :
					{
						'number'      : segments.length,
						'outerRadius' : outerRadius * 0.01,
						'fillStyle'   : pinStyle,
						'strokeStyle' : pinStyle,
						'lineWidth'   : 0,
						'margin'      : outerRadius * 0.01
					},
					'animation' :
					{
						'stopAngle': stopAt,
						'type'     : 'spinToStop',
						'duration' : 15,
						'spins'    : 8,
						'easing'   : 'Power3.easeInOut',
						'callbackFinished' : 'alertPrize()',
						'callbackAfter'    : 'drawPointer()',
					}
				});
				drawPointer();
				setTimeout(function() { theWheel.startAnimation(); }, 1000);
			}
		});

		// Called after the is drawn on each animation loop
		function drawPointer() {
			context.fillStyle   = pointerStyle;
			context.beginPath();
			context.moveTo(pointerPositions[0][0], pointerPositions[0][1]);
			context.lineTo(pointerPositions[1][0], pointerPositions[1][1]);
			context.lineTo(pointerPositions[2][0], pointerPositions[2][1]);
			context.fill();
			context.beginPath();
			context.arc(docWidth / 2, docHeight / 2, outerRadius * 0.025, 0, 2 * Math.PI, false);
			context.fillStyle = pointerStyle;
			context.fill();
		}

		// Called when the animation has finished
		function alertPrize()
		{
			// Close window
			setTimeout(function() { nw.App.quit(); }, 5000);
		}
	</script>
</body>
</html>
